pipeline {
  agent any
  environment {
    IMAGE_NAME = 'flask-shopping-list'  // change if you like
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build') {
      steps {
        // optional diagnostics
        bat 'where docker'
        bat 'docker --version'

        // Compute COMMIT + IMAGE_TAG, then build and save artefact
        bat '''
          setlocal ENABLEDELAYEDEXPANSION
          for /f %%i in ('git rev-parse --short HEAD') do set COMMIT=%%i
          set IMAGE_TAG=%BUILD_NUMBER%-%COMMIT%

          if not exist build mkdir build

          docker build -t %IMAGE_NAME%:%IMAGE_TAG% .

          docker images --no-trunc --quiet %IMAGE_NAME%:%IMAGE_TAG% > build\\image-id.txt
          echo %IMAGE_NAME%:%IMAGE_TAG% > build\\image-tag.txt

          docker save -o build\\%IMAGE_NAME%-%IMAGE_TAG%.tar %IMAGE_NAME%:%IMAGE_TAG%
        '''
      }
    }
stage('Test - Unit') {
  steps {
    bat '''
      setlocal ENABLEDELAYEDEXPANSION
      for /f %%i in ('git rev-parse --short HEAD') do set COMMIT=%%i
      set IMAGE_NAME=flask-shopping-list
      set IMAGE_TAG=%BUILD_NUMBER%-%COMMIT%

      if exist reports rmdir /s /q reports
      mkdir reports\\junit

      docker run --rm ^
        -e CI_IN_CONTAINER=1 ^
        -e PYTHONPATH=/app ^
        -v "%cd%\\tests":/tests ^
        -v "%cd%\\reports":/tests/reports ^
        -w /tests ^
        %IMAGE_NAME%:%IMAGE_TAG% ^
        sh -lc "pip install -q pytest pytest-cov && \
                pytest -q --color=no \
                  --maxfail=1 --disable-warnings \
                  --cov=app --cov-report=term:skip-covered \
                  --cov-report=xml:/tests/reports/coverage.xml \
                  --cov-fail-under=85 \
                  --junitxml=/tests/reports/junit/pytest-unit.xml"
    '''
  }
  post {
    always {
      junit 'reports/junit/pytest-unit.xml'
      archiveArtifacts artifacts: 'reports/**', fingerprint: true
    }
  }
}


stage('Test - Smoke') {
  steps {
    bat '''
      setlocal ENABLEDELAYEDEXPANSION
      for /f %%i in ('git rev-parse --short HEAD') do set COMMIT=%%i
      set IMAGE_NAME=flask-shopping-list
      set IMAGE_TAG=%BUILD_NUMBER%-%COMMIT%
      set PORT=5001

      docker rm -f sl_test 2>nul || echo ok
      docker run -d --name sl_test -p %PORT%:5000 %IMAGE_NAME%:%IMAGE_TAG%

      powershell -Command "$ErrorActionPreference='Stop'; \
        $ok=$false; for($i=0;$i -lt 30;$i++){ \
          try{ $r=Invoke-WebRequest http://localhost:%PORT%/health -UseBasicParsing; if($r.StatusCode -eq 200){ $ok=$true; break } } \
          catch { Start-Sleep -s 2 } \
        }; if(-not $ok){ Write-Error 'App did not become healthy in time'; exit 1 }; \
        $l=Invoke-WebRequest http://localhost:%PORT%/login -UseBasicParsing; \
        if($l.StatusCode -ne 200){ Write-Error 'Login page not OK'; exit 1 }"
      docker rm -f sl_test
    '''
  }
  post {
    failure {
      bat 'echo --- sl_test logs --- & docker logs sl_test || echo (no container) & docker rm -f sl_test || exit /b 0'
    }
  }
}
stage('Code Quality') {
  steps {
    script {
      // Resolve the installed scanner
      def scannerHome = tool name: 'HD', type: 'hudson.plugins.sonar.SonarRunnerInstallation'

      // Inject SONAR_HOST_URL and SONAR_TOKEN from the "HD" server config
      withSonarQubeEnv('HD') {
        // Run the scanner (properties file + a few CLI overrides)
        bat """
          "${scannerHome}\\bin\\sonar-scanner.bat" ^
            -Dsonar.projectVersion=%BUILD_NUMBER% ^
            -Dsonar.host.url=%SONAR_HOST_URL%
        """
      }
    }
  }
}

stage('Security') {
  steps {
    withEnv(["PYTHONWARNINGS=ignore"]) {
      script {
        bat """
        if not exist reports mkdir reports
        if not exist reports\\junit mkdir reports\\junit

        docker run --rm -v "%cd%":/work -w /work python:3.11-slim sh -lc "pip install --no-cache-dir pip-audit bandit >/dev/null 2>&1; \
          pip-audit -r requirements.txt -f json -o reports/pip-audit.json || true; \
          bandit -r app -iii -q -f xml -o reports/bandit.xml || true"

        rem -- read image tag saved in the Build stage
        set /p IMG=<build\\image-tag.txt

        rem -- Trivy table report
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "%cd%\\reports":/reports aquasec/trivy:0.53.0 ^
          image %IMG% --ignore-unfixed --scanners vuln --severity HIGH,CRITICAL ^
          --format table --output /reports/trivy-image.txt || exit /b 0

        rem -- Trivy SARIF (for Warnings NG / SARIF)
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "%cd%\\reports":/reports aquasec/trivy:0.53.0 ^
          image %IMG% --ignore-unfixed --scanners vuln --severity HIGH,CRITICAL ^
          --format sarif --output /reports/trivy-image.sarif || exit /b 0
        """
      }
    }

    // Optional publishers (won’t fail the build if missing)
    recordIssues enabledForFailure: true, tools: [sarif(pattern: 'reports/trivy-image.sarif')]
    archiveArtifacts artifacts: 'reports/**', fingerprint: true
  }
}

stage('Deploy - Staging') {
  when { branch 'main' } // optional: only deploy from main
  steps {
    script {
      // 1) Read the exact image tag saved in Build stage (e.g. "flask-shopping-list:46-abc1234")
      bat '''
        setlocal ENABLEDELAYEDEXPANSION
        if not exist deploy mkdir deploy
        copy /Y docker-compose.staging.yml deploy\\docker-compose.staging.yml >NUL

        for /f %%i in (build\\image-tag.txt) do set IMAGE=%%i
        echo Using image: !IMAGE!

        rem 2) Bring the compose stack up (clean old stack first, don’t fail if nothing is running)
        pushd deploy
        docker compose -f docker-compose.staging.yml down || echo ok

        rem Pass IMAGE to compose via env var so ${IMAGE} is resolved
        set IMAGE=!IMAGE!
        docker compose -f docker-compose.staging.yml up -d --remove-orphans
        popd
      '''

      // 3) Health-check the running app on port 5002
      bat '''
        powershell -Command "$ErrorActionPreference='Stop'; \
          $ok=$false; for($i=0;$i -lt 60;$i++){ \
            try{ $r=Invoke-WebRequest http://localhost:5002/health -UseBasicParsing; \
                 if($r.StatusCode -eq 200){ $ok=$true; break } } \
            catch { Start-Sleep -s 2 } \
          }; if(-not $ok){ Write-Error 'Staging app did not become healthy'; exit 1 }"
      '''
    }
  }
  post {
    success {
      echo 'Staging deployed & healthy at http://localhost:5002'
    }
    failure {
      // Helpful logs on failure
      bat 'docker compose -f deploy\\docker-compose.staging.yml ps > reports\\deploy-ps.txt || echo ok'
      bat 'docker compose -f deploy\\docker-compose.staging.yml logs > reports\\deploy-logs.txt || echo ok'
      archiveArtifacts artifacts: 'reports/deploy-*.txt', fingerprint: true
    }
  }
}

    stage('Archive artefacts') {
      steps {
        archiveArtifacts artifacts: 'build/**', fingerprint: true
      }
    }
  }
}
