pipeline {
  agent any
  environment {
    IMAGE_NAME = 'flask-shopping-list'
  }
  stages {
    stage('Build') {
      steps {
        script {
          // Compute tag from build number + short commit
          env.COMMIT    = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
          env.IMAGE_TAG = "${env.BUILD_NUMBER}-${env.COMMIT}"
        }
        sh """
          set -euxo pipefail
          mkdir -p build
          BUILD_DATE=\$(date -u +%Y-%m-%dT%H:%M:%SZ)

          docker build \
            --label org.opencontainers.image.title=${IMAGE_NAME} \
            --label org.opencontainers.image.revision=${COMMIT} \
            --label org.opencontainers.image.created=\$BUILD_DATE \
            -t ${IMAGE_NAME}:${IMAGE_TAG} .

          docker image inspect ${IMAGE_NAME}:${IMAGE_TAG} --format='{{json .Id}}' > build/image-id.json
          echo "${IMAGE_NAME}:${IMAGE_TAG}" > build/image-tag.txt
          docker save ${IMAGE_NAME}:${IMAGE_TAG} -o build/${IMAGE_NAME}-${IMAGE_TAG}.tar
        """
        archiveArtifacts artifacts: 'build/**', fingerprint: true
      }
    }
  }
}
